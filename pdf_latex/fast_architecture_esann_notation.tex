
\documentclass[border=8pt, multi, tikz]{standalone} 
\usepackage{import}
\subimport{../PlotNeuralNet/layers/}{init}
\usetikzlibrary{positioning}
\usetikzlibrary{3d} %for including external image 
\usetikzlibrary{calc} % For coordinate calculations in overlays
\usetikzlibrary{backgrounds} % For drawing overlays behind architecture

\def\ConvColor{rgb:yellow,5;red,2.5;white,5}
\def\ConvReluColor{rgb:yellow,5;red,5;white,5}
\def\PoolColor{rgb:red,1;black,0.3}
\def\UnpoolColor{rgb:blue,2;green,1;black,0.3}
\def\FcColor{rgb:blue,5;red,2.5;white,5}
\def\FcReluColor{rgb:blue,5;red,5;white,4}
\def\SoftmaxColor{rgb:magenta,5;black,7}   
\def\SumColor{rgb:blue,5;green,15}

\newcommand{\copymidarrow}{\tikz \draw[-Stealth,line width=0.8mm,draw={rgb:blue,4;red,1;green,1;black,3}] (-0.3,0) -- ++(0.3,0);}

\begin{document}
\begin{tikzpicture}
\tikzstyle{connection}=[ultra thick,every node/.style={sloped,allow upside down},draw=\edgecolor,opacity=0.7]
\tikzstyle{copyconnection}=[ultra thick,every node/.style={sloped,allow upside down},draw={rgb:blue,4;red,1;green,1;black,3},opacity=0.7]

\pic[shift={(-1.5,-3,0)}] at (0,3,0) 
    {Box={
        name=mv_input,
        caption=$MV_n^g$\\$40{\times}40{\times}2$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=16,
        width=1,
        depth=10
        }
    };

\pic[shift={(1.5,0,0)}] at (mv_input-east) 
    {Box={
        name=mv_conv,
        caption=Conv\\$40{\times}40{\times}32$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=16,
        width=2,
        depth=10
        }
    };

\draw [connection]  (mv_input-east)    -- node {\midarrow} (mv_conv-west);

\pic[shift={(1.5,0,0)}] at (mv_conv-east) 
    {Box={
        name=mv_upsample,
        caption=Upsample\\$80{\times}80{\times}32$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=22,
        width=2,
        depth=14
        }
    };

\draw [connection]  (mv_conv-east)    -- node {\midarrow} (mv_upsample-west);

\pic[shift={(0,9,0)}] at (0,3,0) 
    {Box={
        name=dct_input,
        caption=$\mathcal{DCT}(\Delta Y_n^g)$\\$80{\times}80{\times}64$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=22,
        width=2,
        depth=14
        }
    };

\pic[shift={(1.5,0,0)}] at (dct_input-east) 
    {Box={
        name=dct_conv,
        caption=Conv\\$80{\times}80{\times}32$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=22,
        width=2,
        depth=14
        }
    };

\draw [connection]  (dct_input-east)    -- node {\midarrow} (dct_conv-west);

\pic[shift={(8,7.0,0)}] at (0,0,0) 
    {Box={
        name=concat,
        caption=Concat\\$80{\times}80{\times}64$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=22,
        width=2.5,
        depth=22
        }
    };

\draw [connection]  (mv_upsample-east)    -- node {\midarrow} (concat-west);

\draw [connection]  (dct_conv-east)    -- node {\midarrow} (concat-west);

\pic[shift={(1.5,0,0)}] at (concat-east) 
    {Box={
        name=conv1,
        caption=Conv\\$H{\times}W{\times}256$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=22,
        width=3,
        depth=22
        }
    };

\draw [connection]  (concat-east)    -- node {\midarrow} (conv1-west);

\pic[shift={(1.5,0,0)}] at (conv1-east) 
    {Box={
        name=conv2,
        caption=Conv\\$H{\times}W{\times}256$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=22,
        width=3,
        depth=22
        }
    };

\draw [connection]  (conv1-east)    -- node {\midarrow} (conv2-west);

\pic[shift={ (1.5,0,0) }] at (conv2-east) 
    {Box={
        name=global_pool,
        caption=GAP\\$256$,
        fill=\PoolColor,
        opacity=0.5,
        height=7,
        width=1,
        depth=7
        }
    };

\draw [connection]  (conv2-east)    -- node {\midarrow} (global_pool-west);

\pic[shift={(1.5,0,0)}] at (global_pool-east) 
    {Box={
        name=features,
        caption=256,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=12,
        width=1,
        depth=1
        }
    };

\draw [connection]  (global_pool-east)    -- node {\midarrow} (features-west);

\pic[shift={(1.5,0,0)}] at (features-east) 
    {Box={
        name=lstm,
        caption=BiLSTM\\256 hidden,
        xlabel={{" ","dummy"}},
        zlabel=,
        fill=\SoftmaxColor,
        opacity=0.8,
        height=12,
        width=2,
        depth=12
        }
    };

\draw [connection]  (features-east)    -- node {\midarrow} (lstm-west);

\pic[shift={(1.5,0,0)}] at (lstm-east) 
    {Box={
        name=bbox_head,
        caption=Detection\\128-dim,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=11,
        width=1.5,
        depth=11
        }
    };

\draw [connection]  (lstm-east)    -- node {\midarrow} (bbox_head-west);

\pic[shift={(1.5,0,0)}] at (bbox_head-east) 
    {Box={
        name=bbox_out,
        caption=$\{\hat{\mathbf{b}}_i\}$\\$N_{det}{\times}4$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=10,
        width=0.5,
        depth=1
        }
    };

\draw [connection]  (bbox_head-east)    -- node {\midarrow} (bbox_out-west);

% Group overlay: MV Encoder
\begin{scope}[on background layer]
\fill[blue!8, rounded corners=15pt] 
    ($(mv_input-nearsouthwest) + (-2.25, -5.5, -3.0)$) rectangle 
    ($(mv_upsample-nearnortheast) + (3.75, 4.5, 3.0)$);
\draw[blue!70!black, line width=3pt, rounded corners=15pt] 
    ($(mv_input-nearsouthwest) + (-2.25, -5.5, -3.0)$) rectangle 
    ($(mv_upsample-nearnortheast) + (3.75, 4.5, 3.0)$);
\end{scope}
% Labels at OVERLAY BOX top-left corner (INSIDE the box)
\node[anchor=north west, font=\bfseries\Large, text=blue!90!black, fill=blue!15, inner sep=5pt, rounded corners=5pt, draw=blue!70!black, line width=2pt] at 
    ($(mv_upsample-nearnortheast) + (-3.45, 3.3, 0)$) {MV Encoder};
\node[anchor=north west, font=\normalsize, text=blue!90!black, fill=blue!15, inner sep=4pt, rounded corners=4pt, draw=blue!50!black, line width=1pt] at 
    ($(mv_upsample-nearnortheast) + (-3.45, 2.0, 0)$) {14K params};

% Group overlay: DCT Encoder
\begin{scope}[on background layer]
\fill[green!8, rounded corners=15pt] 
    ($(dct_input-nearsouthwest) + (-3.75, -4.5, -3.0)$) rectangle 
    ($(dct_conv-nearnortheast) + (3.75, 4.5, 3.0)$);
\draw[green!70!black, line width=3pt, rounded corners=15pt] 
    ($(dct_input-nearsouthwest) + (-3.75, -4.5, -3.0)$) rectangle 
    ($(dct_conv-nearnortheast) + (3.75, 4.5, 3.0)$);
\end{scope}
% Labels at OVERLAY BOX top-left corner (INSIDE the box)
\node[anchor=north west, font=\bfseries\Large, text=green!90!black, fill=green!15, inner sep=5pt, rounded corners=5pt, draw=green!70!black, line width=2pt] at 
    ($(dct_conv-nearnortheast) + (-3.45, 3.3, 0)$) {DCT Encoder};
\node[anchor=north west, font=\normalsize, text=green!90!black, fill=green!15, inner sep=4pt, rounded corners=4pt, draw=green!50!black, line width=1pt] at 
    ($(dct_conv-nearnortheast) + (-3.45, 2.0, 0)$) {18K--74K params (8--64 coeffs)};

% Group overlay: Fusion \& Temporal
\begin{scope}[on background layer]
\fill[orange!8, rounded corners=15pt] 
    ($(concat-nearsouthwest) + (-3.5, -4.0, -4.0)$) rectangle 
    ($(bbox_out-nearnortheast) + (3.5, 5.5, 4.0)$);
\draw[orange!70!black, line width=3pt, rounded corners=15pt] 
    ($(concat-nearsouthwest) + (-3.5, -4.0, -4.0)$) rectangle 
    ($(bbox_out-nearnortheast) + (3.5, 5.5, 4.0)$);
\end{scope}
% Labels at OVERLAY BOX top-left corner (INSIDE the box)
\node[anchor=north west, font=\bfseries\Large, text=orange!90!black, fill=orange!15, inner sep=5pt, rounded corners=5pt, draw=orange!70!black, line width=2pt] at 
    ($(bbox_out-nearnortheast) + (-3.2, 4.5, 4.0)$) {Fusion \& Temporal};
\node[anchor=north west, font=\normalsize, text=orange!90!black, fill=orange!15, inner sep=4pt, rounded corners=4pt, draw=orange!50!black, line width=1pt] at 
    ($(bbox_out-nearnortheast) + (-3.2, 3.0, 4.0)$) {196K params};

\end{tikzpicture}
\end{document}
