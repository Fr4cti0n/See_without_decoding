
\documentclass[border=8pt, multi, tikz]{standalone} 
\usepackage{import}
\subimport{../PlotNeuralNet/layers/}{init}
\usetikzlibrary{positioning}
\usetikzlibrary{3d} %for including external image 
\usetikzlibrary{calc}
\usetikzlibrary{backgrounds}

\def\ConvColor{rgb:yellow,5;red,2.5;white,5}
\def\ConvReluColor{rgb:yellow,5;red,5;white,5}
\def\PoolColor{rgb:red,1;black,0.3}
\def\UnpoolColor{rgb:blue,2;green,1;black,0.3}
\def\FcColor{rgb:blue,5;red,2.5;white,5}
\def\FcReluColor{rgb:blue,5;red,5;white,4}
\def\SoftmaxColor{rgb:magenta,5;black,7}   
\def\SumColor{rgb:blue,5;green,15}

\newcommand{\copymidarrow}{\tikz \draw[-Stealth,line width=0.8mm,draw={rgb:blue,4;red,1;green,1;black,3}] (-0.3,0) -- ++(0.3,0);}

\begin{document}
\begin{tikzpicture}
\tikzstyle{connection}=[ultra thick,every node/.style={sloped,allow upside down},draw=\edgecolor,opacity=0.7]
\tikzstyle{copyconnection}=[ultra thick,every node/.style={sloped,allow upside down},draw={rgb:blue,4;red,1;green,1;black,3},opacity=0.7]

\pic[shift={(0,6,0)}] at (0,0,0) 
    {Box={
        name=prev_boxes,
        caption=Boxes $(t\!-\!1)$\\$N{\times}4$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=12,
        width=1,
        depth=1
        }
    };

\pic[shift={(0,0,0)}] at (0,0,0) 
    {Box={
        name=mv_input,
        caption=$MV_t$\\$60{\times}60{\times}2$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=16,
        width=1.5,
        depth=10
        }
    };

\pic[shift={(0,-6,0)}] at (0,0,0) 
    {Box={
        name=dct_input,
        caption=DCT $(t)$\\$80{\times}80{\times}C$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=18,
        width=2,
        depth=12
        }
    };

\pic[shift={(3,0,0)}] at (prev_boxes-east) 
    {Box={
        name=box_embed,
        caption=Box Enc\\$N{\times}32$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=10,
        width=1.5,
        depth=1
        }
    };

\draw [connection]  (prev_boxes-east)    -- node {\midarrow} (box_embed-west);

\pic[shift={(3,0,0)}] at (mv_input-east) 
    {Box={
        name=roi_motion,
        caption=MV ROI\\Stats,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=14,
        width=2,
        depth=12
        }
    };

\draw [connection]  (mv_input-east)    -- node {\midarrow} (roi_motion-west);

\draw [connection]  (prev_boxes-east)    -- node {\midarrow} (roi_motion-west);

\pic[shift={(2.5,0,0)}] at (roi_motion-east) 
    {Box={
        name=motion_feat,
        caption=$N{\times}64$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=10,
        width=1.5,
        depth=1
        }
    };

\draw [connection]  (roi_motion-east)    -- node {\midarrow} (motion_feat-west);

\pic[shift={(3,0,0)}] at (dct_input-east) 
    {Box={
        name=roi_dct,
        caption=DCT ROI\\Stats,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=14,
        width=2,
        depth=12
        }
    };

\draw [connection]  (dct_input-east)    -- node {\midarrow} (roi_dct-west);

\draw [connection]  (prev_boxes-east)    -- node {\midarrow} (roi_dct-west);

\pic[shift={(2.5,0,0)}] at (roi_dct-east) 
    {Box={
        name=dct_feat,
        caption=$N{\times}32$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=10,
        width=1.5,
        depth=1
        }
    };

\draw [connection]  (roi_dct-east)    -- node {\midarrow} (dct_feat-west);

\pic[shift={(11,0,0)}] at (0,0,0) 
    {Box={
        name=fusion,
        caption=Concat\\$N{\times}128$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=12,
        width=2,
        depth=12
        }
    };

\draw [connection]  (box_embed-east)    -- node {\midarrow} (fusion-west);

\draw [connection]  (motion_feat-east)    -- node {\midarrow} (fusion-west);

\draw [connection]  (dct_feat-east)    -- node {\midarrow} (fusion-west);

\pic[shift={(2.5,0,0)}] at (fusion-east) 
    {Box={
        name=lstm,
        caption=BiLSTM\\$N{\times}128$,
        xlabel={{" ","dummy"}},
        zlabel=,
        fill=\SoftmaxColor,
        opacity=0.8,
        height=12,
        width=2.5,
        depth=12
        }
    };

\draw [connection]  (fusion-east)    -- node {\midarrow} (lstm-west);

\pic[shift={(2.5,0,0)}] at (lstm-east) 
    {Box={
        name=pos_head,
        caption=$\Delta$pos\\$N{\times}2$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=10,
        width=1.5,
        depth=1
        }
    };

\draw [connection]  (lstm-east)    -- node {\midarrow} (pos_head-west);

\pic[shift={(0,-3,0)}] at (pos_head-east) 
    {Box={
        name=size_head,
        caption=$\Delta$size\\$N{\times}2$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=10,
        width=1.5,
        depth=1
        }
    };

\draw [connection]  (lstm-east)    -- node {\midarrow} (size_head-west);

\pic[shift={(2.5,1.5,0)}] at (pos_head-east) 
    {Box={
        name=output_boxes,
        caption=Boxes $(t)$\\$N{\times}4$,
        xlabel={{, }},
        zlabel=,
        fill=\ConvColor,
        height=12,
        width=1,
        depth=1
        }
    };

\draw [connection]  (pos_head-east)    -- node {\midarrow} (output_boxes-west);

\draw [connection]  (size_head-east)    -- node {\midarrow} (output_boxes-west);

% Group overlay: Inputs $(t\!-\!1, t)$
\begin{scope}[on background layer]
\fill[purple!8, rounded corners=15pt] 
    ($(dct_input-nearsouthwest) + (-2.0, -4.0, -2.5)$) rectangle 
    ($(prev_boxes-nearnortheast) + (2.0, 4.0, 2.5)$);
\draw[purple!70!black, line width=3pt, rounded corners=15pt] 
    ($(dct_input-nearsouthwest) + (-2.0, -4.0, -2.5)$) rectangle 
    ($(prev_boxes-nearnortheast) + (2.0, 4.0, 2.5)$);
\end{scope}
% Labels
\node[anchor=north west, font=\bfseries\Large, text=purple!90!black, fill=purple!15, inner sep=5pt, rounded corners=5pt, draw=purple!70!black, line width=2pt] at 
    ($(prev_boxes-nearnortheast) + (-1.7, 2.8, 0)$) {Inputs $(t\!-\!1, t)$};
\node[anchor=north west, font=\normalsize, text=purple!90!black, fill=purple!15, inner sep=4pt, rounded corners=4pt, draw=purple!50!black, line width=1pt] at 
    ($(prev_boxes-nearnortheast) + (-1.7, 1.5, 0)$) {Boxes + MV + DCT};

% Group overlay: ROI Extraction
\begin{scope}[on background layer]
\fill[blue!8, rounded corners=15pt] 
    ($(roi_dct-nearsouthwest) + (-2.5, -4.5, -3.0)$) rectangle 
    ($(motion_feat-nearnortheast) + (2.5, 4.5, 3.0)$);
\draw[blue!70!black, line width=3pt, rounded corners=15pt] 
    ($(roi_dct-nearsouthwest) + (-2.5, -4.5, -3.0)$) rectangle 
    ($(motion_feat-nearnortheast) + (2.5, 4.5, 3.0)$);
\end{scope}
% Labels
\node[anchor=north west, font=\bfseries\Large, text=blue!90!black, fill=blue!15, inner sep=5pt, rounded corners=5pt, draw=blue!70!black, line width=2pt] at 
    ($(motion_feat-nearnortheast) + (-2.2, 3.3, 0)$) {ROI Extraction};
\node[anchor=north west, font=\normalsize, text=blue!90!black, fill=blue!15, inner sep=4pt, rounded corners=4pt, draw=blue!50!black, line width=1pt] at 
    ($(motion_feat-nearnortheast) + (-2.2, 2.0, 0)$) {32K params (box-aligned)};

% Group overlay: Fusion \& Temporal
\begin{scope}[on background layer]
\fill[orange!8, rounded corners=15pt] 
    ($(fusion-nearsouthwest) + (-2.5, -4.5, -3.5)$) rectangle 
    ($(output_boxes-nearnortheast) + (2.5, 4.5, 3.5)$);
\draw[orange!70!black, line width=3pt, rounded corners=15pt] 
    ($(fusion-nearsouthwest) + (-2.5, -4.5, -3.5)$) rectangle 
    ($(output_boxes-nearnortheast) + (2.5, 4.5, 3.5)$);
\end{scope}
% Labels
\node[anchor=north west, font=\bfseries\Large, text=orange!90!black, fill=orange!15, inner sep=5pt, rounded corners=5pt, draw=orange!70!black, line width=2pt] at 
    ($(output_boxes-nearnortheast) + (-2.2, 3.3, 0)$) {Fusion \& Temporal};
\node[anchor=north west, font=\normalsize, text=orange!90!black, fill=orange!15, inner sep=4pt, rounded corners=4pt, draw=orange!50!black, line width=1pt] at 
    ($(output_boxes-nearnortheast) + (-2.2, 2.0, 0)$) {196K params};

\end{tikzpicture}
\end{document}
